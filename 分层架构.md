# 1. 即时通讯的分层架构
<img width="315" height="240" alt="image" src="https://github.com/user-attachments/assets/a4a7d836-1a88-4a94-97ac-cec3e1854939" />

## 1.1 接入层
### 1.1.1 主要任务
- 建立客户端和后台服务的信道
- 接收来自客户端大量并发请求百万连接

### 1.1.2 作用
- 连接整流 http websocket tcp
- 通信安全
- 报文解压缩
- 防攻击 发送速率过快等

<img width="403" height="140" alt="image" src="https://github.com/user-attachments/assets/91aea957-803c-4a77-92a4-dc3ddcec0e15" />

<img width="146" height="140" alt="image" src="https://github.com/user-attachments/assets/21d06d31-fad9-4619-acae-191f2bfedc2d" />

<img width="173" height="140" alt="image" src="https://github.com/user-attachments/assets/ec9748b1-1e67-413d-88d6-4f0129ba50ce" />

## 2.逻辑层
### 2.1 用户逻辑
- 用户登录、用户退出、用户信息查询
- 用户更新签名、用户分组创建、单点登录

### 2.2 好友逻辑
- 添加好友、删除好友
- 拉取好友列表、好友添加备注、黑名单

### 2.3 群组逻辑
- 创建群、加入群、删除群、删除成员

### 2.4 消息逻辑
- 单聊文字消息、单聊语音消息、群聊文字消息
- 群聊语音消息、拉取离线消息

### 2.5 其他
- 文件传输
- 图片传输

## 3.数据层
### 3.1 对上游屏蔽存储引擎

<img width="719" height="149" alt="image" src="https://github.com/user-attachments/assets/95ffd2c9-51e9-4690-b2c8-3caef6b10b64" />

### 3.2 对上游屏蔽缓存cache层

<img width="719" height="148" alt="image" src="https://github.com/user-attachments/assets/52cff08d-5596-45ee-a0d6-adfa527de222" />


### 3.3 对上游提供友好接口

<img width="719" height="183" alt="image" src="https://github.com/user-attachments/assets/298838e7-2eaa-4fcb-8d25-ca3c0dabc9f1" />

### 3.4 数据层-扩展性
当用户量、消息量、群组规模、并发量迅速增加时，IM 系统的数据存储与访问能否 平滑扩展，既保证性能（低延迟）、又保证可靠性（不丢消息、可恢复），还能支持功能扩展（比如消息搜索、漫游、撤回、会话管理）
#### 存储扩展性（水平扩展）
用户、会话、消息 数据量非常大（亿级用户、万亿条消息），需要支持 分库分表、水平切分，每个数据库的访问效率高一些
- 用户数据按 user_id hash 分库。
- 消息数据按 conversation_id 或时间分片。
- 存储系统常用：MySQL 分库 + 中间件（Sharding），或分布式存储（HBase、Cassandra、TiDB、CockroachDB）
